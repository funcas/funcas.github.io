<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="//cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Spring为不同的事务API实现了统一的编程模型，例如：JTA、JDBC、Hibernate、JPA等。而如果使用了声明式事务支持，则使用起来更加简洁，只需要要对应的service方法上加上@Transactional注释，即可开启事务支持。然而正是这种几近于傻瓜化的操作，使得大多数人不再关注事务是否有效，出错时是否按预期正确回滚，反正所有service统统加上事务注解就完事了。而事务的问题在测">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring声明式事务，你用对了吗">
<meta property="og:url" content="https://funcas.top/2020/07/11/post/index.html">
<meta property="og:site_name" content="草堂笔记">
<meta property="og:description" content="Spring为不同的事务API实现了统一的编程模型，例如：JTA、JDBC、Hibernate、JPA等。而如果使用了声明式事务支持，则使用起来更加简洁，只需要要对应的service方法上加上@Transactional注释，即可开启事务支持。然而正是这种几近于傻瓜化的操作，使得大多数人不再关注事务是否有效，出错时是否按预期正确回滚，反正所有service统统加上事务注解就完事了。而事务的问题在测">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://funcas.top/2020/07/11/post/media/15939535503970.jpg">
<meta property="og:image" content="https://funcas.top/2020/07/11/post/media/15939546694477.jpg">
<meta property="og:image" content="https://funcas.top/2020/07/11/post/media/15939579642115.jpg">
<meta property="og:image" content="https://funcas.top/2020/07/11/post/media/15939582549372.jpg">
<meta property="og:image" content="https://funcas.top/2020/07/11/post/media/15939588179582.jpg">
<meta property="og:updated_time" content="2020-07-11T12:11:28.502Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring声明式事务，你用对了吗">
<meta name="twitter:description" content="Spring为不同的事务API实现了统一的编程模型，例如：JTA、JDBC、Hibernate、JPA等。而如果使用了声明式事务支持，则使用起来更加简洁，只需要要对应的service方法上加上@Transactional注释，即可开启事务支持。然而正是这种几近于傻瓜化的操作，使得大多数人不再关注事务是否有效，出错时是否按预期正确回滚，反正所有service统统加上事务注解就完事了。而事务的问题在测">
<meta name="twitter:image" content="https://funcas.top/2020/07/11/post/media/15939535503970.jpg">
  <link rel="canonical" href="https://funcas.top/2020/07/11/post/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Spring声明式事务，你用对了吗 | 草堂笔记</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c530a536ce02e21013b5b5170e12af3a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <meta name="google-site-verification" content="yJU64JNdiWS_XdeDFFw_aSDOBzJwFVweNrT8PRfbU4Y" />
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">草堂笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories" rel="section"><i class="fa fa-fw fa-bookmark"></i>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="https://funcas.top/2020/07/11/post/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Funcas">
      <meta itemprop="description" content="随缘更新，读书笔记、杂记、感想...">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="草堂笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Spring声明式事务，你用对了吗

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-07-11 19:59:46" itemprop="dateCreated datePublished" datetime="2020-07-11T19:59:46+08:00">2020-07-11</time>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/07/11/post/#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2020/07/11/post/" itemprop="commentCount"></span></a>
  </span>
  
  
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>7.8k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>7 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Spring为不同的事务API实现了统一的编程模型，例如：JTA、JDBC、Hibernate、JPA等。而如果使用了声明式事务支持，则使用起来更加简洁，只需要要对应的service方法上加上@Transactional注释，即可开启事务支持。</p><p>然而正是这种几近于傻瓜化的操作，使得大多数人不再关注事务是否有效，出错时是否按预期正确回滚，反正所有service统统加上事务注解就完事了。而事务的问题在测试时是不容易被发现的，直到生产环境跑过一段时间，或数据量上来的时候，才发现业务数据掺杂了大量脏数据时，就不得不人工进行数据清洗了。</p><a id="more"></a>

<p>回想第一次踩事务的坑的时候是2010年，那会刚毕业，对事务一知半解，并且那会也没这么幸福，用的是xml配置事务拦截器，然后方法名必须按特定规则才能被事务拦截器拦截到。然后就踩了不少坑，这里特别感谢下华仔的事务启蒙。所以在这里分享一下这几年在事务上遇到的一些坑及解决方案。</p>
<h2 id="你认为的事务也许并没有生效">你认为的事务，也许并没有生效</h2>
<p>加了@Transactional注解后，事务就一定有效吗？ 这里直接列出失效情况，原理后面再分析。</p>
<h3 id="事务注解在非public方法上">事务注解在非public方法上</h3>
<p>如下面这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.saveEntity(entity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Test <span class="title">saveEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    demoRepository.save(entity);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"test only"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然了，这个是比较低级的错误了，相信除非手误，不然一般不会犯这个错。特别是，如果你使用IDEA，直接会提示出错误信息给你，并且给你了修复建议： <img src="/2020/07/11/post/media/15939535503970.jpg"></p>
<h3 id="事务方法被内部调用">事务方法被内部调用</h3>
<p>于是，我们按照提示修复，给方法声明成public，再来试一次：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.saveEntity(entity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Test <span class="title">saveEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    demoRepository.save(entity);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"test only"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而，很遗憾，一边异常抛得很开心，另一边数据库也写得很开心。方法明明加了事务注解，方法里明明抛了异常，可是，事务就是没生效。</p>
<h3 id="but-why">BUT WHY?</h3>
<p>Spring事务使用的是AOP方式对业务方法做了增强，如下图所示:（来自Spring官网) <img src="/2020/07/11/post/media/15939546694477.jpg"> 而AOP实现是使用了动态代理，所以必须是从代理方法调用才拥有事务增强的能力，走内部方法，事务自然就失效了。同时也解释了，为什么不能注解在private方法上，还是因为动态代理啊，private是无法被代理到的。以下来自Spring官方文档说明</p>
<blockquote>
<p>Due to the proxy-based nature of Spring’s AOP framework, calls within the target object are, by definition, not intercepted. For JDK proxies, only public interface method calls on the proxy can be intercepted. With CGLIB, public and protected method calls on the proxy are intercepted (and even package-visible methods, if necessary). However, common interactions through proxies should always be designed through public signatures.</p>
</blockquote>
<p>知道了原因后，解决方法也就显而易见了： 第一种，简单粗暴的方法，直接注入一下自己，然后再来调用即可，使用注入的实例来调用，就相当于从走了AOP Proxy，相当于欺骗了AOP一下下。 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ITransactionTestService _this;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    _this.saveEntity(entity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Test <span class="title">saveEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    demoRepository.save(entity);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"test only"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>鉴于第一种不够优雅，一些强迫症的程序猿们是无法接受的（比如我），查看了Spring文档后，才发现，原来Spring 早就替我们想好了。以下摘自Spring官方文档对exposeProxy这个配置属性的说明：</p>
<blockquote>
<p>exposeProxy: Determines whether or not the current proxy should be exposed in a ThreadLocal so that it can be accessed by the target. If a target needs to obtain the proxy and the exposeProxy property is set to true, the target can use the AopContext.currentProxy() method.</p>
</blockquote>
<p>于是动手改造下我们的代码，加上AOP的配置，将proxy暴露出来，对于SpringBoot可以直接加上注解配置</p>
<blockquote>
<p><span class="citation" data-cites="EnableAspectJAutoProxy">@EnableAspectJAutoProxy</span>(exposeProxy = true)</p>
</blockquote>
<p>对应于xml则加上</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">expose-proxy</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后回到我们的业务代码，进行改造</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    ((ITransactionTestService)AopContext.currentProxy()).saveEntity(entity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Test <span class="title">saveEntity</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    demoRepository.save(entity);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"test only"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实验后发现，事务按预期回滚。说明我们通过AopContext.currentProxy()成功地获取到了当前的代理。</p>
<p>其实在翻Spring文档的过程中，又发现了第三种连代码都不需要修改的方法——使用AspectJ替换CGLIB做动态代理增强：</p>
<blockquote>
<p>If your interception needs include method calls or even constructors within the target class, consider the use of Spring-driven native AspectJ weaving instead of Spring’s proxy-based AOP framework. This constitutes a different mode of AOP usage with different characteristics, so be sure to make yourself familiar with weaving before making a decision.</p>
</blockquote>
<p>AspectJ的织入方式又可分为三种：ompile-time weaving （编译时织入）、 Post-compile weaving （后编译织入）、 Load-time weaving （加载时织入）。 对于前面两种，是在编译过程对你的字节码进行增强，所以不需要非得使用代理实例来调用才生效，相当于你自己写了事务代码在源代码中的感觉；而LTW则是在类加载时动态修改了你业务类的字节码，并对期增强，三种方式可以说是殊途同归，但是配置上却有所不同</p>
<h3 id="配置使用aspectj作为spring事务代理增强模式ltw">配置使用AspectJ作为Spring事务代理增强模式——LTW</h3>
<p>首先，我们需要在配置上开启Spring事务模式为AspectJ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span>(mode = AdviceMode.ASPECTJ)</span><br></pre></td></tr></table></figure>
<p>然后启用LTW</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableLoadTimeWeaving</span>(aspectjWeaving = EnableLoadTimeWeaving.AspectJWeaving.ENABLED)</span><br></pre></td></tr></table></figure>
<p>在启动参数上添加agent:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:/your path/spring-instrument-5.2.7.RELEASE.jar</span><br><span class="line">-javaagent:/your path/aspectjweaver-1.9.5.jar</span><br></pre></td></tr></table></figure>
<p>最后，在META-INF/aop.xml声明需要进行织入的目标类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE aspectj PUBLIC "-//AspectJ//DTD//EN" "http://www.eclipse.org/aspectj/dtd/aspectj.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aspectj</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">weaver</span> <span class="attr">options</span>=<span class="string">"-verbose -showWeaveInfo"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">            Only weave classes in our application-specific packages.</span></span><br><span class="line"><span class="comment">            This should encompass any class that wants to utilize the aspects,</span></span><br><span class="line"><span class="comment">            and does not need to encompass the aspects themselves.</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">within</span>=<span class="string">"com.funcas.demo..*"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">weaver</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">aspectj</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置使用aspectj作为spring事务代理增强模式ctw">配置使用AspectJ作为Spring事务代理增强模式——CTW</h3>
<p>首先同样是开启事务前声明模式为AspectJ</p>
<blockquote>
<p><span class="citation" data-cites="EnableTransactionManagement">@EnableTransactionManagement</span>(mode = AdviceMode.ASPECTJ)</p>
</blockquote>
<p>然后加入aspectj的maven插件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nickwongdev<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectj-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">complianceLevel</span>&gt;</span>8<span class="tag">&lt;/<span class="name">complianceLevel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">showWeaveInfo</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showWeaveInfo</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Xlint</span>&gt;</span>ignore<span class="tag">&lt;/<span class="name">Xlint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aspectLibraries</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">aspectLibrary</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">aspectLibrary</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">aspectLibraries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">showWeaveInfo</span>&gt;</span>true<span class="tag">&lt;/<span class="name">showWeaveInfo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置完成后，我们可以尝试执行下 <code>mvn aspectj:compile</code> 进行编译。</p>
<p>编译成功后，我们查看一下生成的class文件，你会发现，与平时编译出来的差别比较大：<img src="/2020/07/11/post/media/15939579642115.jpg"></p>
<p>并且我们的TransactionTestServiceImpl后反编译出来的代码，也是不太一样： <img src="/2020/07/11/post/media/15939582549372.jpg"></p>
<p>其实这个就是我们在编译的时候被AspectJ做了增强的结果。</p>
<h2 id="事务生效了可是没有回滚">事务生效了，可是没有回滚</h2>
<p>Spring的事务管理，可以这么简单理解，它对我们的业务代码方法块中做了try...catch，一旦我们的<strong>业务代码块抛出异常，且满足特定条件的时候</strong>，就设置事务回滚，否则提交事务。</p>
<p>所以想要事务回滚，首先要在注解了@Transactional方法内，抛出了异常，其次，在默认情况下，只有非受检异常和Error（两者都包含子类），Spring才会做回滚。</p>
<p>我们来看一下Spring在DefaultTransactionAttribute对rollbackOn的注释，明确声明了，默认只能RuntimeException和Error进行回滚。 <img src="/2020/07/11/post/media/15939588179582.jpg"></p>
<p>于是，当你在业务方法内抛出了受检异常时，事务将不会回滚，而直接提交。例子这里就不举了，你可以简单地做个实验，在业务方法内抛出</p>
<blockquote>
<p>throw new FileNotFoundException("test rollback!");</p>
</blockquote>
<p>试看看事务是否按预期回滚。</p>
<p>解决这个问题的方式也比较容易，在@Transactional添加rollbackFor的属性，添加你想要回滚的受检异常类即可，如果想要无差别回滚，就把Exception.class写上去，那么这时只要有异常发生就会发生回滚：</p>
<blockquote>
<p><span class="citation" data-cites="Transactional">@Transactional</span>(rollbackFor = Exception.class)</p>
</blockquote>
<p>同样地，有rollbackFor也有对应的noRollbackFor，这个属性用于对不需要回滚的异常做排除处理，灵活运用这两个属性，即可以灵活处理不同的业务场景。</p>
<h2 id="异常没有被抛出事务却回滚了">异常没有被抛出，事务却回滚了</h2>
<p>看到这个标题，相信小伙伴们的第一反应就是：你TM在逗我？？？ 这个是比较反直觉的，我们前面一直在讨论的是出了异常事务没有回滚，而这里却是，明明捕获了所有异常了，事务却莫名奇妙地回滚了。</p>
<p>我们来看下面这个例子:</p>
<p>先定义一个UserService， 并且让里面的saveUser方法抛异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    userRepository.save(user);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们在主业务方法里调用这个带异常的方法，由于铁定出java.lang.ArithmeticException异常，所以我们对其做try...catch，好让异常不会暴露给Spring TransactionManagement。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save2</span><span class="params">(Test entity)</span> </span>&#123;</span><br><span class="line">    demoRepository.save(entity);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        userService.saveUser(<span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起来一切正常，此时，应该是Test这个表被保存，User表会被回滚。然而，事实是，这两张表事务都被回滚了，并且得到了这么一个异常:</p>
<blockquote>
<p>org.springframework.transaction.UnexpectedRollbackException: Transaction silently rolled back because it has been marked as rollback-only</p>
</blockquote>
<p>提示很明朗了，事务被静默回滚了，由于事务被标记成了回滚。what? 怎么事务就被标记成回滚了？</p>
<p>其实这个涉及到的是Spring的事务传播，默认是REQUIRED，意思就是有当前有事务就加入事务，没有事务的话就新建一个。Spring的事务传播行为有七种，如下表：</p>
<table>
<colgroup>
<col style="width: 60%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>传播行为</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PROPAGATION_REQUIRED</td>
<td>如果存在一个事务，则支持当前事务。如果没有事务则开启一个新的事务</td>
</tr>
<tr class="even">
<td>PROPAGATION_SUPPORTS</td>
<td>如果存在一个事务，支持当前事务。如果没有事务，则非事务的执行</td>
</tr>
<tr class="odd">
<td>PROPAGATION_MANDATORY</td>
<td>如果已经存在一个事务，支持当前事务。如果没有一个活动的事务，则抛出异常</td>
</tr>
<tr class="even">
<td>PROPAGATION_REQUIRED_NEW</td>
<td>开启一个新的事务,如果一个事务已经存在，则先将这个存在的事务挂起</td>
</tr>
<tr class="odd">
<td>PROPAGATION_NOT_SUPPORT</td>
<td>总是非事务地执行，并挂起任何存在的事务</td>
</tr>
<tr class="even">
<td>PROPAGATION_NEVER</td>
<td>总是非事务地执行，如果存在一个活动事务，则抛出异常</td>
</tr>
<tr class="odd">
<td>PROPAGATION_NESTED</td>
<td>如果一个活动的事务存在，则运行在一个嵌套的事务中;如果没有活动事务, 则按TransactionDefinition.PROPAGATION_REQUIRED 属性执行</td>
</tr>
</tbody>
</table>
<p>所以，UserService的事务加入了当前事务中来，并且抛出了异常，这个时候使得整个事务被标记成了回滚。</p>
<p>想要实现主任务正常执行，子任务在异常时也可以回滚的话，可以修改其默认传播行为为：PROPAGATION_REQUIRED_NEW，即开启新的事务，并挂起当前事务。我们来对代码做简单修正：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Transactional</span>(rollbackFor = Exception.class, propagation = Propagation.REQUIRES_NEW)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    userRepository.save(user);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次运行后可以现，现在两个事务互不影响，子事务即使出现异常，也只回滚了子事务，对主事务不会回滚。这种场景适合在主表保存成功后需要做一些后置操作，但后置操作又不应该影响到主线流程的这种情况。</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2020/04/18/post/" rel="next" title="盛最多水的容器题解记录">
                  <i class="fa fa-chevron-left"></i> 盛最多水的容器题解记录
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2020/07/25/post/" rel="prev" title="数值计算：你与首富的距离可能就差这“一点”">
                  数值计算：你与首富的距离可能就差这“一点” <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="comments"></div>
  

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#你认为的事务也许并没有生效"><span class="nav-number">1.</span> <span class="nav-text">你认为的事务，也许并没有生效</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事务注解在非public方法上"><span class="nav-number">1.1.</span> <span class="nav-text">事务注解在非public方法上</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务方法被内部调用"><span class="nav-number">1.2.</span> <span class="nav-text">事务方法被内部调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#but-why"><span class="nav-number">1.3.</span> <span class="nav-text">BUT WHY?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置使用aspectj作为spring事务代理增强模式ltw"><span class="nav-number">1.4.</span> <span class="nav-text">配置使用AspectJ作为Spring事务代理增强模式——LTW</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置使用aspectj作为spring事务代理增强模式ctw"><span class="nav-number">1.5.</span> <span class="nav-text">配置使用AspectJ作为Spring事务代理增强模式——CTW</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务生效了可是没有回滚"><span class="nav-number">2.</span> <span class="nav-text">事务生效了，可是没有回滚</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异常没有被抛出事务却回滚了"><span class="nav-number">3.</span> <span class="nav-text">异常没有被抛出，事务却回滚了</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.jpg"
      alt="Funcas">
  <p class="site-author-name" itemprop="name">Funcas</p>
  <div class="site-description" itemprop="description">随缘更新，读书笔记、杂记、感想...</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories">
          
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/funcas" title="GitHub &rarr; https://github.com/funcas" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://weibo.com/funcasion" title="Weibo &rarr; https://weibo.com/funcasion" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Funcas</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">27k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">25 分钟</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="//cdn.bootcss.com/animejs/3.1.0/anime.min.js"></script>
  <script src="//cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

  


<script>
NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'brfXUyPtevWzNxHVFTd1Ig5i-9Nh9j0Va',
    appKey: 'LfGhuxD7dxTdWLukqWDBHmYc',
    placeholder: '评论区',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname
  });
}, window.Valine);
</script>

</body>
</html>
